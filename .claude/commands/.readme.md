┌───────────────────────────────────────────────────────────────────────────┐
│                                  START                                    │
└───────────────────────────────────────────────────────────────────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ /nb-0  Deepener (Reality Check)                                            │
│ - reads docs/new-brief.md + codebase + docs/USER_JOURNEY.md                │
│ - asks exactly 10 clarifying questions                                     │
└───────────────────────────────────────────────────────────────────────────┘
                                     |
                          (human answers 10 Qs)
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ /nb-loop  Orchestrator: runs nb-1 -> nb-2 -> nb-3 -> nb-4                  │
│ (stops on errors)                                                         │
└───────────────────────────────────────────────────────────────────────────┘
          |                 |                 |                 |
          v                 v                 v                 v
┌───────────────┐   ┌────────────────┐   ┌────────────────┐   ┌───────────────┐
│ /nb-1         │   │ /nb-2          │   │ /nb-3          │   │ /nb-4         │
│ Restructure   │   │ Diff & Patch   │   │ Packager       │   │ Verifier      │
│ new-brief2.md │-->| lossless align │-->| docs/brief.md  │-->| brief vs nb   │
└───────────────┘   └────────────────┘   └────────────────┘   └───────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ BTS: Brief -> Specs                                                        │
└───────────────────────────────────────────────────────────────────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ /bts-0  Compiler -> writes docs/specs.md (repo-aware, TBD not guesses)      │
└───────────────────────────────────────────────────────────────────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ /bts-loop  Orchestrator: alternates bts-1 <-> bts-2 until converged         │
└───────────────────────────────────────────────────────────────────────────┘
               |                                 ^
               v                                 |
      ┌─────────────────┐        patch payload   |
      │ /bts-1 Auditor  │----> docs/spec_improve.md
      └─────────────────┘                         |
               |                                  |
               v                                  |
      ┌─────────────────┐  applies surgical edits |
      │ /bts-2 Patcher  │-------------------------┘
      └─────────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ STCC: Specs -> Code Patches (two loops)                                    │
└───────────────────────────────────────────────────────────────────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ /stcc-0 Planner -> writes docs/code_patches.md (anchors verified, BLOCKER) │
└───────────────────────────────────────────────────────────────────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ /stcc-loop  Compliance loop: stcc-1 audit; if gaps run stcc-2/3/4/5; repeat │
└───────────────────────────────────────────────────────────────────────────┘
               |                                 ^
               v                                 |
      ┌─────────────────┐        COMPLETE?       |
      │ /stcc-1 Auditor │---- NO: run corrections |
      └─────────────────┘                         |
               |                                  |
               v                                  |
      ┌─────────────────────────────┐             |
      │ stcc-2/3/4/5 Correction set │-------------┘
      └─────────────────────────────┘
               |
              YES (100% coverage)
               |
               v
┌───────────────────────────────────────────────────────────────────────────┐
│ /stcc-loop2  Safety convergence: stcc-6 -> stcc-7 -> stcc-8 -> repeat       │
└───────────────────────────────────────────────────────────────────────────┘
               |                                 ^
               v                                 |
      ┌─────────────────┐      PASS/UNSURE/FAIL  |
      │ /stcc-6 Reviewer│------------------------|
      └─────────────────┘                        |
               |                                 |
               v                                 |
      ┌─────────────────┐  moves PASS -> confirmed
      │ /stcc-7 Splitter│--> docs/code_patches_confirmed.md
      └─────────────────┘                        |
               |                                 |
               v                                 |
      ┌─────────────────┐  rewrites UNSURE/FAIL  |
      │ /stcc-8 Repair  │------------------------┘
      └─────────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ IC: Implement confirmed patches (strict sequence, stop on verification fail)│
└───────────────────────────────────────────────────────────────────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ /ic-loop  Orchestrator: runs ic-0 -> ic-1 -> ic-2 -> ic-3 -> ic-4 -> ic-5   │
└───────────────────────────────────────────────────────────────────────────┘
   |        |        |        |        |        |
   v        v        v        v        v        v
┌───────┐ ┌────────┐┌────────┐┌────────┐┌────────┐┌──────────────┐
│ ic-0  │ │ ic-1   ││ ic-2   ││ ic-3   ││ ic-4   ││ ic-5         │
│ apply │ │ checksum││ verify ││ backlog││ 2nd    ││ brief->repo  │
│ plan  │ │ ledger  ││ disk   ││ build  ││ pass   ││ audit ->     │
│       │ │ .md     ││ truth  ││ confirmed2.md   ││ docs/verifier│
└───────┘ └────────┘└────────┘└────────┘└────────┘└──────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│ Support workflows (optional / post-pass)                                   │
│ - /ic-git           (branch + single deterministic commit)                 │
│ - /ic-housekeeping  (propose doc deltas)                                   │
│ - /ic-lfg           (apply doc deltas + delete intermediate artifacts)      │
└───────────────────────────────────────────────────────────────────────────┘
                                     |
                                     v
┌───────────────────────────────────────────────────────────────────────────┐
│                                   END                                     │
└───────────────────────────────────────────────────────────────────────────┘
